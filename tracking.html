<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>배송 추적 - AOL LOGISTICS</title>
  <meta name="description" content="AOL Logistics - Track your shipment easily and securely.">


  <!-- Favicon -->
  <link rel="icon" type="image/png" href="images/images (2).jpeg" />

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-G5C2122TVD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-G5C2122TVD');
  </script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- AOS (optional animations if you want) -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    body { background-color: #0b1220; color: #f9fafb; font-family: "Inter", sans-serif; }
    .progress-icon { width: 50px; height: 50px; }
    #mobileMenu.mobile-menu { max-height: 0; overflow: hidden; transition: max-height 300ms ease, opacity 250ms ease; opacity: 0; }
    #mobileMenu.mobile-menu.open { max-height: 420px; opacity: 1; }
    #progressLine { height: 4px; }
    .progress-step { width: 50%; }
    @media (min-width: 640px) { .progress-step { width: auto; } }
    #map { height: 420px; width: 100%; border-radius: 10px; margin: 20px 0; box-shadow: 0 6px 20px rgba(2,6,23,0.6); border: 1px solid rgba(255,255,255,0.03); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); }
    .timeline-item { padding-left: 0.75rem; border-left-width: 2px; border-left-color: rgba(14,165,233,0.85); }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- Header/Navbar (copied / unified from tracking-form.html) -->
  <header class="bg-gray-900 shadow-md fixed top-0 left-0 w-full z-50">
    <div class="container mx-auto flex items-center justify-between px-6 py-3">
      <a href="home.html" class="flex items-center space-x-2">
        <img src="images/images (2).jpeg" alt="Logo" class="h-12 w-12 object-cover rounded-full hidden sm:block">
        <div class="flex flex-col leading-tight">
          <h1 class="text-lg md:text-xl font-bold text-sky-400 italic truncate" data-key="brandTaglineTitle">AOL LOGISTICS</h1>
          <p data-key="brandTagline" class="text-xs italic text-gray-300 -mt-1 tracking-tight hidden sm:block">delivery service at its finest</p>
        </div>
      </a>

      <!-- Desktop Nav -->
      <nav class="hidden md:flex space-x-6 text-gray-300">
        <a data-key="navAbout" href="home.html#about" class="hover:text-sky-400">회사 소개</a>
        <a data-key="navServices" href="home.html#services" class="hover:text-sky-400">서비스</a>
        <a data-key="navTracking" href="tracking.html" class="hover:text-sky-400 font-semibold text-sky-400">배송 추적</a>
        <a data-key="navForm" href="form.html" class="hover:text-sky-400">배송 생성</a>
        <a data-key="navNews" href="home.html#news" class="hover:text-sky-400">뉴스</a>
        <a data-key="navContact" href="home.html#contact" class="hover:text-sky-400">연락처</a>
        <a data-key="navLogin" href="admin/login.html" class="hover:text-sky-400">로그인</a>
      </nav>

      <!-- Buttons -->
      <div class="flex items-center">
        <button id="langToggle" aria-label="Toggle language" class="ml-4 bg-sky-400 text-gray-900 px-4 py-2 rounded font-semibold">English</button>
        <button id="menuBtn" aria-expanded="false" aria-label="Toggle menu" class="md:hidden bg-sky-400 text-gray-900 px-4 py-2 rounded ml-3">메뉴</button>
      </div>
    </div>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="hidden bg-gray-800 text-gray-300 md:hidden flex flex-col space-y-3 px-6 py-4">
      <a data-key="navAbout" href="home.html#about" class="hover:text-sky-400">회사 소개</a>
      <a data-key="navServices" href="home.html#services" class="hover:text-sky-400">서비스</a>
      <a data-key="navTracking" href="tracking.html" class="hover:text-sky-400 font-semibold text-sky-400">배송 추적</a>
      <a data-key="navForm" href="form.html" class="hover:text-sky-400">배송 생성</a>
      <a data-key="navNews" href="home.html#news" class="hover:text-sky-400">뉴스</a>
      <a data-key="navContact" href="home.html#contact" class="hover:text-sky-400">연락처</a>
      <a data-key="navLogin" href="admin/login.html" class="hover:text-sky-400">로그인</a>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-grow pt-32 pb-20">
    <div class="container mx-auto px-6" data-aos="fade-up">
      <h2 data-key="pageTitle" class="text-3xl font-bold text-center mb-8 text-sky-400">배송 추적</h2>

      <!-- Shipment Summary -->
      <div id="shipmentSummary" class="bg-gray-800 shadow-lg rounded-xl p-6 mb-4 hidden">
        <h3 class="text-xl font-semibold mb-4 text-sky-400" data-key="shipmentDetails">배송 세부 정보</h3>
        <div class="grid md:grid-cols-2 gap-4 text-sm">
          <p><strong data-key="trackingNoLabel">운송장 번호:</strong> <span id="summaryTrackingNo"></span></p>
          <p><strong data-key="customerLabel">고객:</strong> <span id="summaryCustomer"></span></p>
          <p><strong data-key="originLabel">출발지:</strong> <span id="summaryOrigin"></span></p>
          <p><strong data-key="destinationLabel">도착지:</strong> <span id="summaryDestination"></span></p>
          <p><strong data-key="statusLabel">상태:</strong> <span id="summaryStatus" class="font-semibold text-sky-400"></span></p>
          <p><strong data-key="locationLabel">현재 위치:</strong> <span id="summaryLocation" class="font-semibold text-gray-300"></span></p>
        </div>
      </div>

      <!-- Map -->
      <div id="map" class="hidden" aria-hidden="true"></div>

      <!-- Progress Bar -->
      <div id="progressSection" class="mb-8 hidden">
        <h3 class="text-xl font-semibold mb-4 text-sky-400" data-key="shipmentProgress">배송 진행 상황</h3>
        <div class="relative flex items-center justify-between">
          <div class="absolute top-1/2 inset-x-0 mx-auto h-1 bg-gray-600 -z-10 rounded w-full max-w-[90%]"></div>
          <div id="progressLine" class="absolute top-1/2 left-0 h-1 bg-sky-500 -z-10 rounded transition-all duration-500" style="width:0%;"></div>

          <div id="stepPending" class="flex flex-col items-center relative z-10 w-1/4">
            <img src="https://cdn-icons-png.flaticon.com/512/861/861060.png" alt="Pending" class="progress-icon opacity-50">
            <p class="mt-2 text-sm" data-key="orderPlaced">주문 접수</p>
          </div>
          <div id="stepTransit" class="flex flex-col items-center relative z-10 w-1/4">
            <img src="https://cdn-icons-png.flaticon.com/512/263/263142.png" alt="In Transit" class="progress-icon opacity-50">
            <p class="mt-2 text-sm" data-key="preparing">준비 중</p>
          </div>
          <div id="stepShipped" class="flex flex-col items-center relative z-10 w-1/4">
            <img src="https://cdn-icons-png.flaticon.com/512/1995/1995560.png" alt="Shipped" class="progress-icon opacity-50">
            <p class="mt-2 text-sm" data-key="shipped">배송 중</p>
          </div>
          <div id="stepDelivered" class="flex flex-col items-center relative z-10 w-1/4">
            <img src="https://cdn-icons-png.flaticon.com/512/190/190411.png" alt="Delivered" class="progress-icon opacity-50">
            <p class="mt-2 text-sm" data-key="delivered">배송 완료</p>
          </div>
        </div>
      </div>

      <!-- Timeline -->
      <div id="updatesTimeline" class="bg-gray-800 shadow-lg rounded-xl p-6 hidden">
        <h3 class="text-xl font-semibold mb-6 text-sky-400" data-key="trackingUpdates">배송 업데이트</h3>
        <div id="timeline" class="relative border-l border-gray-600 pl-6 space-y-6"></div>
      </div>

      <div id="message" class="text-center text-gray-400 mt-6"></div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-900 py-6 text-center text-gray-400 text-sm border-t border-gray-800">
    <p data-key="footerText">© 2025 AOL Logistics. All rights reserved.</p>
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
  AOS && AOS.init && AOS.init({ duration: 700, easing: 'ease-in-out' });

  /***** CONFIG (replace with your real values if needed) *****/
  const SUPABASE_URL = "https://byvffsxsfehrybkyamyu.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5dmZmc3hzZmVocnlia3lhbXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNDM0MjMsImV4cCI6MjA3MzgxOTQyM30.R99A5PQ2t9keXeQdglGlq35IOGRk7d3NsqPbe9Dw8uY"; // replace if needed

  /***** INIT supabase client *****/
  const { createClient } = supabase;
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

  /***** DOM refs *****/
  const menuBtn = document.getElementById("menuBtn");
  const mobileMenu = document.getElementById("mobileMenu");
  const langToggle = document.getElementById("langToggle");

  const params = new URLSearchParams(window.location.search);
  const trackingNo = params.get("tracking_no");

  const summaryEl = document.getElementById("shipmentSummary");
  const updatesEl = document.getElementById("updatesTimeline");
  const progressEl = document.getElementById("progressSection");
  const timelineEl = document.getElementById("timeline");
  const messageEl = document.getElementById("message");
  const progressLine = document.getElementById("progressLine");
  const mapEl = document.getElementById("map");

  /***** Translations (comprehensive) *****/
  const translations = {
    ko: {
      brandTaglineTitle: "AOL LOGISTICS",
      brandTagline: "최상의 배송 서비스",
      navAbout: "회사 소개",
      navServices: "서비스",
      navTracking: "배송 추적",
      navForm: "배송 생성",
      navNews: "뉴스",
      navContact: "연락처",
      navLogin: "로그인",
      pageTitle: "배송 추적",
      shipmentDetails: "배송 세부 정보",
      trackingNoLabel: "운송장 번호:",
      customerLabel: "고객:",
      originLabel: "출발지:",
      destinationLabel: "도착지:",
      statusLabel: "상태:",
      locationLabel: "현재 위치:",
      shipmentProgress: "배송 진행 상황",
      orderPlaced: "주문 접수",
      preparing: "운송 중",
      shipped: "배송됨",
      delivered: "배송 완료",
      trackingUpdates: "배송 업데이트",
      loadingShipment: "배송 정보를 불러오는 중...",
      invalidCodeMessage: "유효하지 않은 운송장 코드입니다.",
      notAvailable: "사용 불가",
      unknown: "알 수 없음",
      footerText: "© 2025 AOL 물류. 모든 권리 보유."
    },
    en: {
      brandTaglineTitle: "AOL LOGISTICS",
      brandTagline: "delivery service at its finest",
      navAbout: "About",
      navServices: "Services",
      navTracking: "Track Shipment",
      navForm: "Create Shipment",
      navNews: "News",
      navContact: "Contact",
      navLogin: "Login",
      pageTitle: "Track Your Shipment",
      shipmentDetails: "Shipment Details",
      trackingNoLabel: "Tracking No:",
      customerLabel: "Customer:",
      originLabel: "Origin:",
      destinationLabel: "Destination:",
      statusLabel: "Status:",
      locationLabel: "Current Location:",
      shipmentProgress: "Shipment Progress",
      orderPlaced: "Order Placed",
      preparing: "In Transit",
      shipped: "Shipped",
      delivered: "Delivered",
      trackingUpdates: "Tracking Updates",
      loadingShipment: "Loading shipment...",
      invalidCodeMessage: "Invalid tracking code.",
      notAvailable: "Not available",
      unknown: "Unknown",
      footerText: "© 2025 AOL Logistics. All rights reserved."
    }
  };

  /***** status mapping helpers *****/
  const statusMapping = {
    "Order Placed": { key: "orderPlaced", stepId: "stepPending" },
    "Preparing Shipment": { key: "preparing", stepId: "stepTransit" },
    "Shipped": { key: "shipped", stepId: "stepShipped" },
    "Delivered": { key: "delivered", stepId: "stepDelivered" }
  };
  const orderStatuses = Object.keys(statusMapping);

  function normalizeProgress(raw) {
    if (!raw) return "Order Placed";
    const trimmed = String(raw).trim();

    if (orderStatuses.includes(trimmed)) return trimmed;

    const koMap = {
      "주문 접수": "Order Placed",
      "접수": "Order Placed",
      "준비 중": "Preparing Shipment",
      "준비": "Preparing Shipment",
      "배송 중": "Shipped",
      "배송": "Shipped",
      "배송 완료": "Delivered",
      "완료": "Delivered"
    };
    if (koMap[trimmed]) return koMap[trimmed];

    const lower = trimmed.toLowerCase();
    if (lower.includes("order") || lower.includes("placed") || lower.includes("접수")) return "Order Placed";
    if (lower.includes("prepare") || lower.includes("preparing") || lower.includes("준비")) return "Preparing Shipment";
    if (lower.includes("ship") && !lower.includes("deliver")) return "Shipped";
    if (lower.includes("deliver") || lower.includes("완료")) return "Delivered";
    return "Order Placed";
  }

  /***** language state and rendering *****/
  let currentLang = localStorage.getItem('site_lang') || 'ko';

  function applyTranslations(lang) {
    document.querySelectorAll('[data-key]').forEach(el => {
      const key = el.getAttribute('data-key');
      if (key && translations[lang] && translations[lang][key]) {
        el.textContent = translations[lang][key];
      }
    });
  }

  // store fetched data to allow re-render when language changes
  let fetchedShipment = null;
  let fetchedUpdates = [];

  function escapeHtml(str = "") {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;");
  }

  function highlightStep(normalizedProgress) {
    const idx = orderStatuses.indexOf(normalizedProgress);
    const activeIndex = Math.max(0, idx === -1 ? 0 : idx);
    ["stepPending","stepTransit","stepShipped","stepDelivered"].forEach(id => {
      const step = document.getElementById(id);
      if (!step) return;
      const img = step.querySelector("img");
      const p = step.querySelector("p");
      if (img) img.classList.add("opacity-50");
      if (p) { p.classList.remove("font-bold"); p.classList.remove("text-sky-400"); }
    });
    for (let i = 0; i <= activeIndex; i++) {
      const id = ["stepPending","stepTransit","stepShipped","stepDelivered"][i];
      const step = document.getElementById(id);
      if (!step) continue;
      const img = step.querySelector("img");
      const p = step.querySelector("p");
      if (img) img.classList.remove("opacity-50");
      if (p) { p.classList.add("font-bold"); p.classList.add("text-sky-400"); }
    }
    const percent = (activeIndex / (orderStatuses.length - 1)) * 100;
    progressLine.style.width = `${percent}%`;
  }

  function renderDynamicContent() {
    // loading message
    if (messageEl.dataset.loading === "true") {
      messageEl.textContent = translations[currentLang].loadingShipment || "Loading...";
    }

    if (!fetchedShipment) return;

    document.getElementById("summaryTrackingNo").textContent = fetchedShipment.tracking_no || "-";
    document.getElementById("summaryCustomer").textContent = fetchedShipment.receiver_name || "-";
    document.getElementById("summaryOrigin").textContent = fetchedShipment.origin || "-";
    document.getElementById("summaryDestination").textContent = fetchedShipment.receiver_country || fetchedShipment.destination || "-";

    const latest = (fetchedUpdates && fetchedUpdates.length) ? fetchedUpdates[0] : null;
    const normalized = normalizeProgress(latest?.progress || fetchedShipment.status || "Order Placed");
    const statusKey = statusMapping[normalized]?.key || 'orderPlaced';
    const localizedStatus = translations[currentLang][statusKey] || normalized;
    document.getElementById("summaryStatus").textContent = localizedStatus;
    document.getElementById("summaryLocation").textContent = (latest?.location || fetchedShipment.location_text || fetchedShipment.location || translations[currentLang].notAvailable || "Not available");

    highlightStep(normalized);

    if (fetchedUpdates && fetchedUpdates.length) {
      updatesEl.classList.remove("hidden");
      timelineEl.innerHTML = fetchedUpdates.map(update => {
        const norm = normalizeProgress(update.progress);
        const statusKey2 = statusMapping[norm]?.key || 'orderPlaced';
        const displayStatus = translations[currentLang][statusKey2] || norm;
        const displayLocation = update.location || translations[currentLang].unknown || "Unknown";
        const timeStr = update.created_at ? new Date(update.created_at).toLocaleString() : "";
        const noteHtml = update.note ? `<p class="mt-1 text-gray-400 italic">${escapeHtml(update.note)}</p>` : "";
        return `
          <div class="relative">
            <div class="absolute -left-3 top-1 w-6 h-6 rounded-full bg-sky-500 border-2 border-gray-900"></div>
            <div class="ml-4">
              <p class="font-semibold text-sky-400">${escapeHtml(displayStatus)}</p>
              <p class="text-gray-300">${escapeHtml(displayLocation)}</p>
              <p class="text-sm text-gray-400">${escapeHtml(timeStr)}</p>
              ${noteHtml}
            </div>
          </div>
        `;
      }).join("");
    } else {
      timelineEl.innerHTML = `<p class="text-gray-400">${translations[currentLang].notAvailable}</p>`;
    }

    applyTranslations(currentLang);
  }

  /***** toggle mobile menu *****/
  let menuOpen = false;
  menuBtn.addEventListener('click', () => {
    menuOpen = !menuOpen;
    if (menuOpen) {
      mobileMenu.classList.add('open');
      mobileMenu.classList.remove('hidden');
    } else {
      mobileMenu.classList.remove('open');
    }
    menuBtn.setAttribute('aria-expanded', String(menuOpen));
  });

  /***** language toggle button *****/
  function setLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('site_lang', lang);
    document.documentElement.lang = (lang === 'ko') ? 'ko' : 'en';
    applyTranslations(lang);
    langToggle.textContent = (lang === 'ko') ? 'English' : '한국어';
    langToggle.setAttribute('aria-pressed', String(lang === 'en'));
    // re-render dynamic content if we already fetched it
    renderDynamicContent();
  }

  langToggle.addEventListener('click', () => {
    const next = (currentLang === 'ko') ? 'en' : 'ko';
    setLanguage(next);
  });

  // initial language set
  setLanguage(currentLang);

  /***** Map logic *****/
  let mapInstance = null;
  let mapMarker = null;
  async function updateMapTo(lat, lng, popupText = "") {
    if (!lat || !lng) return;
    if (!mapInstance) {
      mapInstance = L.map('map').setView([lat, lng], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(mapInstance);
      mapMarker = L.marker([lat, lng]).addTo(mapInstance).bindPopup(popupText || '');
      mapEl.classList.remove('hidden');
    } else {
      mapInstance.setView([lat, lng], mapInstance.getZoom() || 11);
      if (mapMarker) {
        mapMarker.setLatLng([lat, lng]).setPopupContent(popupText || '');
      } else {
        mapMarker = L.marker([lat, lng]).addTo(mapInstance).bindPopup(popupText || '');
      }
    }
  }

  async function deriveCoordinates(shipment, latestUpdate) {
    const geocodeCandidate = latestUpdate?.location || shipment.location || shipment.location_text;
    if (geocodeCandidate && typeof geocodeCandidate === 'string') {
      try {
        const q = encodeURIComponent(geocodeCandidate);
        const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${q}`;
        const resp = await fetch(url, { headers: { 'Accept': 'application/json' }});
        if (!resp.ok) throw new Error('Geocode failed');
        const j = await resp.json();
        if (Array.isArray(j) && j.length > 0) {
          return [Number(j[0].lat), Number(j[0].lon)];
        }
      } catch (err) {
        console.warn('Geocode error', err);
      }
    }
    return [null, null];
  }

  /***** Core: load tracking data *****/
  async function loadTracking() {
    if (!trackingNo) {
      // if no tracking number, send back to tracking form
      window.location.href = "tracking-form.html";
      return;
    }
    messageEl.dataset.loading = "true";
    messageEl.textContent = translations[currentLang].loadingShipment || "Loading...";
    try {
      const { data: shipment, error: shipmentError } = await supabaseClient
        .from("user_info")
        .select("*")
        .eq("tracking_no", trackingNo)
        .maybeSingle();
      if (shipmentError || !shipment) {
        const q = new URLSearchParams({ error: "invalid", code: trackingNo });
        window.location.href = `tracking-form.html?${q.toString()}`;
        return;
      }
      const { data: updates, error: updatesError } = await supabaseClient
        .from("tracking_updates")
        .select("*")
        .eq("shipment_id", shipment.id)
        .order("created_at", { ascending: false });
      if (updatesError) console.warn('updates error', updatesError);
      fetchedShipment = shipment;
      fetchedUpdates = updates || [];
      summaryEl.classList.remove("hidden");
      renderDynamicContent();
      const latestUpdate = fetchedUpdates.length ? fetchedUpdates[0] : null;
      const [lat, lng] = await deriveCoordinates(fetchedShipment, latestUpdate);
      if (lat && lng) {
        await updateMapTo(lat, lng, `<strong>${escapeHtml(fetchedShipment.receiver_name || 'Package')}</strong><br>${escapeHtml(latestUpdate?.location || fetchedShipment.location || '')}`);
      } else {
        mapEl.classList.add('hidden');
      }
      progressEl.classList.remove("hidden");
      if (fetchedUpdates.length) updatesEl.classList.remove("hidden");
      messageEl.textContent = "";
      delete messageEl.dataset.loading;
    } catch (err) {
      console.error(err);
      messageEl.textContent = "⚠️ Error loading shipment.";
    }
  }

  /***** Refresh helper *****/
  let refreshTimer = null;
  async function refreshTrackingIfChanged() {
    if (!fetchedShipment) return;
    try {
      const { data: shipmentFresh, error: err } = await supabaseClient
        .from("user_info")
        .select("*")
        .eq("id", fetchedShipment.id)
        .maybeSingle();
      if (err || !shipmentFresh) return;
      const wasChanged =
        shipmentFresh.location !== fetchedShipment.location ||
        shipmentFresh.location_text !== fetchedShipment.location_text ||
        shipmentFresh.status !== fetchedShipment.status;
      if (wasChanged) {
        fetchedShipment = shipmentFresh;
        const { data: updatesFresh } = await supabaseClient
          .from("tracking_updates")
          .select("*")
          .eq("shipment_id", fetchedShipment.id)
          .order("created_at", { ascending: false });
        fetchedUpdates = updatesFresh || [];
        renderDynamicContent();
        const latestUpdate = fetchedUpdates.length ? fetchedUpdates[0] : null;
        const [lat, lng] = await deriveCoordinates(fetchedShipment, latestUpdate);
        if (lat && lng) {
          updateMapTo(lat, lng, `<strong>${escapeHtml(fetchedShipment.receiver_name || 'Package')}</strong><br>${escapeHtml(latestUpdate?.location || fetchedShipment.location || '')}`);
        }
      }
    } catch (err) {
      console.warn('refresh error', err);
    }
  }

  // Start
  loadTracking().then(() => {
    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(refreshTrackingIfChanged, 15000);
  });

  /***** cleanup on close *****/
  window.addEventListener('beforeunload', () => {
    if (refreshTimer) clearInterval(refreshTimer);
  });

  /***** show invalid error if someone lands here with error param (optional) *****/
  // If you want to display an inline message for ?error=invalid on this page as well:
  (function showErrorIfPresent() {
    const err = params.get('error');
    if (err === 'invalid') {
      const code = params.get('code') || '';
      messageEl.classList.remove('text-gray-400');
      messageEl.classList.add('text-red-400');
      messageEl.textContent = `${translations[currentLang].invalidCodeMessage} ${code}`;
      messageEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  })();

</script>

</body>
</html>
